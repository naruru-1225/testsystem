<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒ†ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 30px;
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-card h3 {
        font-size: 36px;
        margin-bottom: 5px;
      }
      .stat-card p {
        font-size: 14px;
        opacity: 0.9;
      }
      .test-section {
        margin-bottom: 30px;
      }
      .test-section h2 {
        color: #667eea;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .test-list {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
      }
      .test-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 10px;
        background: white;
        border-radius: 5px;
        border-left: 4px solid #ddd;
      }
      .test-item.running {
        border-left-color: #ffc107;
      }
      .test-item.success {
        border-left-color: #28a745;
      }
      .test-item.failed {
        border-left-color: #dc3545;
      }
      .test-item.pending {
        border-left-color: #6c757d;
      }
      .test-name {
        font-weight: 500;
        color: #333;
      }
      .test-status {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }
      .status-pending {
        background: #6c757d;
        color: white;
      }
      .status-running {
        background: #ffc107;
        color: #333;
      }
      .status-success {
        background: #28a745;
        color: white;
      }
      .status-failed {
        background: #dc3545;
        color: white;
      }
      .test-button {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .test-button:hover {
        background: #5568d3;
      }
      .test-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result-details {
        margin-top: 10px;
        padding: 10px;
        background: #f1f3f5;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        display: none;
      }
      .result-details.show {
        display: block;
      }
      .run-all-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 20px;
        width: 100%;
      }
      .run-all-btn:hover {
        background: #218838;
      }
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“Š ãƒ†ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="subtitle">
        é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒ http://localhost:3000
        ã§èµ·å‹•ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§å®Ÿè¡Œã—ã¦ãã ã•ã„
      </p>

      <div class="stats">
        <div class="stat-card">
          <h3 id="total-tests">0</h3>
          <p>ç·ãƒ†ã‚¹ãƒˆæ•°</p>
        </div>
        <div
          class="stat-card"
          style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%)"
        >
          <h3 id="passed-tests">0</h3>
          <p>æˆåŠŸ</p>
        </div>
        <div
          class="stat-card"
          style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)"
        >
          <h3 id="failed-tests">0</h3>
          <p>å¤±æ•—</p>
        </div>
        <div
          class="stat-card"
          style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)"
        >
          <h3 id="success-rate">0%</h3>
          <p>æˆåŠŸç‡</p>
        </div>
      </div>

      <button class="run-all-btn" onclick="runAllTests()">
        ğŸš€ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      </button>

      <!-- Folders API Tests -->
      <div class="test-section">
        <h2>ğŸ“ Folders API ãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-list" id="folders-tests"></div>
      </div>

      <!-- Categories API Tests -->
      <div class="test-section">
        <h2>ğŸ“š Categories API ãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-list" id="categories-tests"></div>
      </div>

      <!-- Tags API Tests -->
      <div class="test-section">
        <h2>ğŸ·ï¸ Tags API ãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-list" id="tags-tests"></div>
      </div>

      <!-- Tests API Tests -->
      <div class="test-section">
        <h2>ğŸ“ Tests API ãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-list" id="tests-tests"></div>
      </div>

      <!-- PDF API Tests -->
      <div class="test-section">
        <h2>ğŸ“„ PDF API ãƒ†ã‚¹ãƒˆ</h2>
        <div class="test-list" id="pdf-tests"></div>
      </div>
    </div>

    <script>
      const BASE_URL = "http://localhost:3000";
      let totalTests = 0;
      let passedTests = 0;
      let failedTests = 0;

      const tests = {
        folders: [
          {
            name: "GET /api/folders - ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å–å¾—",
            test: testGetFolders,
          },
          {
            name: "GET /api/folders - order_indexã§ã‚½ãƒ¼ãƒˆ",
            test: testFoldersSort,
          },
          {
            name: "POST /api/folders - æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ",
            test: testCreateFolder,
          },
          {
            name: "PUT /api/folders - ãƒ•ã‚©ãƒ«ãƒ€é †åºæ›´æ–°",
            test: testUpdateFolderOrder,
          },
        ],
        categories: [
          {
            name: "GET /api/categories - ã‚«ãƒ†ã‚´ãƒªä¸€è¦§å–å¾—",
            test: testGetCategories,
          },
          { name: "GET /api/categories - å­¦å¹´ãƒã‚¹ã‚¿ãƒ¼ç¢ºèª", test: testGrades },
          {
            name: "GET /api/categories - ç§‘ç›®ãƒã‚¹ã‚¿ãƒ¼ç¢ºèª",
            test: testSubjects,
          },
        ],
        tags: [
          { name: "GET /api/tags - ã‚¿ã‚°ä¸€è¦§å–å¾—", test: testGetTags },
          { name: "POST /api/tags - æ–°è¦ã‚¿ã‚°ä½œæˆ", test: testCreateTag },
        ],
        tests: [
          { name: "GET /api/tests - ãƒ†ã‚¹ãƒˆä¸€è¦§å–å¾—", test: testGetTests },
          {
            name: "GET /api/tests?folder=1 - ãƒ•ã‚©ãƒ«ãƒ€ãƒ•ã‚£ãƒ«ã‚¿",
            test: testFilterByFolder,
          },
          {
            name: "GET /api/tests?search=ãƒ†ã‚¹ãƒˆ - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢",
            test: testSearch,
          },
        ],
        pdf: [
          {
            name: "GET /api/pdf/[...path] - 404ã‚¨ãƒ©ãƒ¼ç¢ºèª",
            test: testPdfNotFound,
          },
        ],
      };

      function initTests() {
        for (const [section, sectionTests] of Object.entries(tests)) {
          const container = document.getElementById(`${section}-tests`);
          sectionTests.forEach((test, index) => {
            const testItem = document.createElement("div");
            testItem.className = "test-item pending";
            testItem.id = `test-${section}-${index}`;
            testItem.innerHTML = `
                        <span class="test-name">${test.name}</span>
                        <div>
                            <span class="test-status status-pending" id="status-${section}-${index}">æœªå®Ÿè¡Œ</span>
                            <button class="test-button" onclick="runTest('${section}', ${index})">å®Ÿè¡Œ</button>
                        </div>
                        <div class="result-details" id="result-${section}-${index}"></div>
                    `;
            container.appendChild(testItem);
            totalTests++;
          });
        }
        updateStats();
      }

      async function runTest(section, index) {
        const testItem = document.getElementById(`test-${section}-${index}`);
        const statusEl = document.getElementById(`status-${section}-${index}`);
        const resultEl = document.getElementById(`result-${section}-${index}`);

        testItem.className = "test-item running";
        statusEl.className = "test-status status-running";
        statusEl.innerHTML = 'å®Ÿè¡Œä¸­... <span class="loader"></span>';
        resultEl.classList.remove("show");

        try {
          const result = await tests[section][index].test();
          testItem.className = "test-item success";
          statusEl.className = "test-status status-success";
          statusEl.textContent = "âœ… æˆåŠŸ";
          resultEl.textContent = result.message || "æˆåŠŸ";
          resultEl.style.color = "#28a745";
          passedTests++;
        } catch (error) {
          testItem.className = "test-item failed";
          statusEl.className = "test-status status-failed";
          statusEl.textContent = "âŒ å¤±æ•—";
          resultEl.textContent = error.message;
          resultEl.style.color = "#dc3545";
          failedTests++;
        }

        resultEl.classList.add("show");
        updateStats();
      }

      async function runAllTests() {
        passedTests = 0;
        failedTests = 0;

        for (const [section, sectionTests] of Object.entries(tests)) {
          for (let i = 0; i < sectionTests.length; i++) {
            await runTest(section, i);
            await new Promise((resolve) => setTimeout(resolve, 500));
          }
        }
      }

      function updateStats() {
        document.getElementById("total-tests").textContent = totalTests;
        document.getElementById("passed-tests").textContent = passedTests;
        document.getElementById("failed-tests").textContent = failedTests;
        const successRate =
          totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
        document.getElementById("success-rate").textContent = `${successRate}%`;
      }

      // Test implementations
      async function testGetFolders() {
        const response = await fetch(`${BASE_URL}/api/folders`);
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        if (data.length === 0) throw new Error("ãƒ•ã‚©ãƒ«ãƒ€ãŒ0ä»¶ã§ã™");
        return { message: `${data.length}ä»¶ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—` };
      }

      async function testFoldersSort() {
        const response = await fetch(`${BASE_URL}/api/folders`);
        const data = await response.json();
        for (let i = 0; i < data.length - 1; i++) {
          const current = data[i].order_index ?? data[i].id;
          const next = data[i + 1].order_index ?? data[i + 1].id;
          if (current > next) {
            throw new Error(`é †åºãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ${current} > ${next}`);
          }
        }
        return { message: "order_indexã§ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™" };
      }

      async function testCreateFolder() {
        const response = await fetch(`${BASE_URL}/api/folders`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: `ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€_${Date.now()}` }),
        });
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!data.id) throw new Error("IDãŒè¿”ã•ã‚Œã¾ã›ã‚“");

        // ä½œæˆã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤
        await fetch(`${BASE_URL}/api/folders/${data.id}`, { method: "DELETE" });
        return { message: `ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆæˆåŠŸ (ID: ${data.id})` };
      }

      async function testUpdateFolderOrder() {
        const response = await fetch(`${BASE_URL}/api/folders`);
        const folders = await response.json();
        const folderIds = folders.map((f) => f.id);

        const updateResponse = await fetch(`${BASE_URL}/api/folders`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ folderIds }),
        });

        if (!updateResponse.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${updateResponse.status}`);
        const data = await updateResponse.json();
        if (!data.success) throw new Error("success=trueãŒè¿”ã•ã‚Œã¾ã›ã‚“");
        return { message: `${folderIds.length}ä»¶ã®ãƒ•ã‚©ãƒ«ãƒ€é †åºã‚’æ›´æ–°` };
      }

      async function testGetCategories() {
        const response = await fetch(`${BASE_URL}/api/categories`);
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        return { message: `${data.length}ä»¶ã®å­¦å¹´ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—` };
      }

      async function testGrades() {
        const response = await fetch(`${BASE_URL}/api/categories`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        if (data.length === 0) throw new Error("ãƒ†ã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹å­¦å¹´ãŒ0ä»¶ã§ã™");

        // å„ã‚«ãƒ†ã‚´ãƒªã« grade ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        for (const category of data) {
          if (!category.grade) {
            throw new Error("gradeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        }
        return { message: `ãƒ†ã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹å­¦å¹´: ${data.length}ä»¶` };
      }

      async function testSubjects() {
        const response = await fetch(`${BASE_URL}/api/categories`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");

        let totalSubjects = 0;
        for (const category of data) {
          if (!Array.isArray(category.subjects)) {
            throw new Error(
              `å­¦å¹´ã€Œ${category.grade}ã€ã®subjectsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“`
            );
          }
          totalSubjects += category.subjects.length;
        }

        if (totalSubjects === 0) throw new Error("ç§‘ç›®ãŒ1ä»¶ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return { message: `åˆè¨ˆ ${totalSubjects}ä»¶ã®ç§‘ç›®ã‚’ç¢ºèª` };
      }

      async function testGetTags() {
        const response = await fetch(`${BASE_URL}/api/tags`);
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        return { message: `${data.length}ä»¶ã®ã‚¿ã‚°ã‚’å–å¾—` };
      }

      async function testCreateTag() {
        const response = await fetch(`${BASE_URL}/api/tags`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: `ãƒ†ã‚¹ãƒˆã‚¿ã‚°_${Date.now()}`,
            color: "#FF5733",
          }),
        });
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!data.id) throw new Error("IDãŒè¿”ã•ã‚Œã¾ã›ã‚“");

        // ä½œæˆã—ãŸã‚¿ã‚°ã‚’å‰Šé™¤
        await fetch(`${BASE_URL}/api/tags/${data.id}`, { method: "DELETE" });
        return { message: `ã‚¿ã‚°ä½œæˆæˆåŠŸ (ID: ${data.id})` };
      }

      async function testGetTests() {
        const response = await fetch(`${BASE_URL}/api/tests`);
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        return { message: `${data.length}ä»¶ã®ãƒ†ã‚¹ãƒˆã‚’å–å¾—` };
      }

      async function testFilterByFolder() {
        const response = await fetch(`${BASE_URL}/api/tests?folder=1`);
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        return { message: `ãƒ•ã‚©ãƒ«ãƒ€ID=1: ${data.length}ä»¶ã®ãƒ†ã‚¹ãƒˆ` };
      }

      async function testSearch() {
        const response = await fetch(
          `${BASE_URL}/api/tests?search=${encodeURIComponent("ãƒ†ã‚¹ãƒˆ")}`
        );
        if (!response.ok)
          throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data))
          throw new Error("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        return { message: `æ¤œç´¢çµæœ: ${data.length}ä»¶` };
      }

      async function testPdfNotFound() {
        const response = await fetch(
          `${BASE_URL}/api/pdf/pdfs/nonexistent.pdf`
        );
        if (response.status !== 404)
          throw new Error(`æœŸå¾…: 404, å®Ÿéš›: ${response.status}`);
        return { message: "404ã‚¨ãƒ©ãƒ¼ãŒæ­£ã—ãè¿”ã•ã‚Œã¾ã—ãŸ" };
      }

      // Initialize
      initTests();
    </script>
  </body>
</html>
