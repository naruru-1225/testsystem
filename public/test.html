<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API ãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .test-section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-section h2 {
        color: #2196f3;
        margin-top: 0;
      }
      .test-item {
        margin: 10px 0;
        padding: 10px;
        border-left: 4px solid #ddd;
        background: #f9f9f9;
      }
      .test-item.success {
        border-left-color: #4caf50;
        background: #f1f8f4;
      }
      .test-item.error {
        border-left-color: #f44336;
        background: #fef1f0;
      }
      .test-name {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .test-result {
        font-size: 14px;
        color: #666;
      }
      .summary {
        background: #2196f3;
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 30px;
      }
      .summary h2 {
        color: white;
        margin-top: 0;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .loading {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: #666;
      }
      pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª API ç·åˆãƒ†ã‚¹ãƒˆ</h1>

    <div>
      <button id="runAllTests" onclick="runAllTests()">
        ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      </button>
      <button onclick="clearResults()">çµæœã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <div id="loading" class="loading" style="display: none">
      ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...
    </div>

    <div id="results"></div>
    <div id="summary"></div>

    <script>
      let passCount = 0;
      let failCount = 0;

      async function testEndpoint(name, url, method = "GET", body = null) {
        try {
          const options = { method };
          if (body) {
            options.headers = { "Content-Type": "application/json" };
            options.body = JSON.stringify(body);
          }

          const response = await fetch(url, options);
          const data = await response.json();

          if (response.ok) {
            return { success: true, data, status: response.status };
          } else {
            return {
              success: false,
              error: data.error || "Unknown error",
              status: response.status,
            };
          }
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      function addTestResult(sectionId, testName, result, details = "") {
        let section = document.getElementById(sectionId);
        if (!section) {
          section = document.createElement("div");
          section.id = sectionId;
          section.className = "test-section";
          document.getElementById("results").appendChild(section);
        }

        const item = document.createElement("div");
        item.className = `test-item ${result.success ? "success" : "error"}`;

        const icon = result.success ? "âœ“" : "âœ—";
        const color = result.success ? "#4CAF50" : "#f44336";

        item.innerHTML = `
        <div class="test-name" style="color: ${color}">${icon} ${testName}</div>
        <div class="test-result">${details}</div>
      `;

        section.appendChild(item);

        if (result.success) {
          passCount++;
        } else {
          failCount++;
          item.innerHTML += `<div style="color: #f44336; margin-top: 5px;">ã‚¨ãƒ©ãƒ¼: ${result.error}</div>`;
        }
      }

      async function runAllTests() {
        passCount = 0;
        failCount = 0;
        document.getElementById("results").innerHTML = "";
        document.getElementById("summary").innerHTML = "";
        document.getElementById("loading").style.display = "block";
        document.getElementById("runAllTests").disabled = true;

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
        const sections = [
          { id: "section1", title: "1. å­¦å¹´ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿" },
          { id: "section2", title: "2. ç§‘ç›®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿" },
          { id: "section3", title: "3. ã‚¿ã‚°ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿" },
          { id: "section4", title: "4. ãƒ•ã‚©ãƒ«ãƒ€" },
          { id: "section5", title: "5. ãƒ†ã‚¹ãƒˆä¸€è¦§å–å¾—" },
          { id: "section6", title: "6. ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½" },
          { id: "section7", title: "7. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½" },
        ];

        sections.forEach((sec) => {
          const section = document.createElement("div");
          section.id = sec.id;
          section.className = "test-section";
          section.innerHTML = `<h2>${sec.title}</h2>`;
          document.getElementById("results").appendChild(section);
        });

        // 1. å­¦å¹´ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
        const gradesResult = await testEndpoint("å­¦å¹´ä¸€è¦§å–å¾—", "/api/grades");
        addTestResult(
          "section1",
          "GET /api/grades",
          gradesResult,
          gradesResult.success ? `å–å¾—ä»¶æ•°: ${gradesResult.data.length}ä»¶` : ""
        );

        // 2. ç§‘ç›®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
        const subjectsResult = await testEndpoint(
          "ç§‘ç›®ä¸€è¦§å–å¾—",
          "/api/subjects"
        );
        addTestResult(
          "section2",
          "GET /api/subjects",
          subjectsResult,
          subjectsResult.success
            ? `å–å¾—ä»¶æ•°: ${subjectsResult.data.length}ä»¶`
            : ""
        );

        // 3. ã‚¿ã‚°ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
        const tagsResult = await testEndpoint("ã‚¿ã‚°ä¸€è¦§å–å¾—", "/api/tags");
        addTestResult(
          "section3",
          "GET /api/tags",
          tagsResult,
          tagsResult.success ? `å–å¾—ä»¶æ•°: ${tagsResult.data.length}ä»¶` : ""
        );

        // 4. ãƒ•ã‚©ãƒ«ãƒ€
        const foldersResult = await testEndpoint(
          "ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§å–å¾—",
          "/api/folders"
        );
        addTestResult(
          "section4",
          "GET /api/folders",
          foldersResult,
          foldersResult.success
            ? `å–å¾—ä»¶æ•°: ${foldersResult.data.length}ä»¶`
            : ""
        );

        // 5. ãƒ†ã‚¹ãƒˆä¸€è¦§
        const testsResult = await testEndpoint("ãƒ†ã‚¹ãƒˆä¸€è¦§å–å¾—", "/api/tests");
        addTestResult(
          "section5",
          "GET /api/tests",
          testsResult,
          testsResult.success ? `å–å¾—ä»¶æ•°: ${testsResult.data.length}ä»¶` : ""
        );

        if (testsResult.success && testsResult.data.length > 0) {
          const test = testsResult.data[0];
          addTestResult(
            "section5",
            "ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª",
            { success: true },
            `ä¾‹: ${test.name} (å­¦å¹´: ${test.grade}, ç§‘ç›®: ${
              test.subject
            }, ã‚¿ã‚°: ${test.tags.map((t) => t.name).join(", ") || "ãªã—"})`
          );
        }

        // 6. ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
        if (tagsResult.success && tagsResult.data.length > 0) {
          const tagId = tagsResult.data[0].id;
          const tagName = tagsResult.data[0].name;
          const tagFilterResult = await testEndpoint(
            "ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿",
            `/api/tests?tagId=${tagId}`
          );
          addTestResult(
            "section6",
            `ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ (tagId=${tagId})`,
            tagFilterResult,
            tagFilterResult.success
              ? `ã€Œ${tagName}ã€ã§ãƒ•ã‚£ãƒ«ã‚¿: ${tagFilterResult.data.length}ä»¶`
              : ""
          );
        }

        if (gradesResult.success && gradesResult.data.length > 0) {
          const grade = gradesResult.data[0].name;
          const gradeFilterResult = await testEndpoint(
            "å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿",
            `/api/tests?grade=${encodeURIComponent(grade)}`
          );
          addTestResult(
            "section6",
            `å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ (grade=${grade})`,
            gradeFilterResult,
            gradeFilterResult.success
              ? `ã€Œ${grade}ã€ã§ãƒ•ã‚£ãƒ«ã‚¿: ${gradeFilterResult.data.length}ä»¶`
              : ""
          );
        }

        if (subjectsResult.success && subjectsResult.data.length > 0) {
          const subject = subjectsResult.data[0].name;
          const subjectFilterResult = await testEndpoint(
            "ç§‘ç›®ãƒ•ã‚£ãƒ«ã‚¿",
            `/api/tests?subject=${encodeURIComponent(subject)}`
          );
          addTestResult(
            "section6",
            `ç§‘ç›®ãƒ•ã‚£ãƒ«ã‚¿ (subject=${subject})`,
            subjectFilterResult,
            subjectFilterResult.success
              ? `ã€Œ${subject}ã€ã§ãƒ•ã‚£ãƒ«ã‚¿: ${subjectFilterResult.data.length}ä»¶`
              : ""
          );
        }

        if (
          gradesResult.success &&
          subjectsResult.success &&
          gradesResult.data.length > 0 &&
          subjectsResult.data.length > 0
        ) {
          const grade = gradesResult.data[0].name;
          const subject = subjectsResult.data[0].name;
          const combinedResult = await testEndpoint(
            "è¤‡åˆãƒ•ã‚£ãƒ«ã‚¿",
            `/api/tests?grade=${encodeURIComponent(
              grade
            )}&subject=${encodeURIComponent(subject)}`
          );
          addTestResult(
            "section6",
            `è¤‡åˆãƒ•ã‚£ãƒ«ã‚¿ (å­¦å¹´Ã—ç§‘ç›®)`,
            combinedResult,
            combinedResult.success
              ? `ã€Œ${grade}ã€Ã—ã€Œ${subject}ã€: ${combinedResult.data.length}ä»¶`
              : ""
          );
        }

        const searchResult = await testEndpoint(
          "æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿",
          "/api/tests?search=ãƒ†ã‚¹ãƒˆ"
        );
        addTestResult(
          "section6",
          "æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ (search=ãƒ†ã‚¹ãƒˆ)",
          searchResult,
          searchResult.success
            ? `ã€Œãƒ†ã‚¹ãƒˆã€ã§æ¤œç´¢: ${searchResult.data.length}ä»¶`
            : ""
        );

        // 7. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—)
        addTestResult(
          "section7",
          "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆAPI",
          { success: true },
          "æ‰‹å‹•ãƒ†ã‚¹ãƒˆ: ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ > å¾©å…ƒã‚¿ãƒ– > ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„"
        );

        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        document.getElementById("loading").style.display = "none";
        document.getElementById("runAllTests").disabled = false;

        const totalTests = passCount + failCount;
        const successRate =
          totalTests > 0 ? ((passCount / totalTests) * 100).toFixed(1) : 0;

        document.getElementById("summary").innerHTML = `
        <div class="summary">
          <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
          <p style="font-size: 24px; margin: 10px 0;">
            æˆåŠŸ: <strong>${passCount}</strong> / å¤±æ•—: <strong>${failCount}</strong> / åˆè¨ˆ: <strong>${totalTests}</strong>
          </p>
          <p style="font-size: 18px;">æˆåŠŸç‡: <strong>${successRate}%</strong></p>
          ${
            failCount === 0
              ? '<p style="font-size: 20px; margin-top: 20px;">âœ“ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ! ğŸ‰</p>'
              : '<p style="font-size: 20px; margin-top: 20px; color: #ffeb3b;">âš ï¸ ã„ãã¤ã‹ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ</p>'
          }
        </div>
      `;
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
        document.getElementById("summary").innerHTML = "";
        passCount = 0;
        failCount = 0;
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
      window.onload = () => {
        runAllTests();
      };
    </script>
  </body>
</html>
