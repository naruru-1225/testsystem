# iPad PDF 閲覧エラー - デバッグガイド v3.1

## 🔍 今回の変更点

### バージョン 3.1 の追加変更

1. **PDF.js 読み込みプロセスの詳細ログ追加**

   - `onLoadStart`: PDF 読み込み開始時
   - `onLoadProgress`: PDF 読み込み進捗
   - Document レンダリング前のログ

2. **PDF.js verbosity を最大(5)に設定**

   - PDF.js 内部のすべてのログを出力
   - エラーが発生している箇所を特定

3. **レンダリング前のログ追加**
   - PDF 表示モード、画像表示モードそれぞれでログ出力

### バージョン 3.0 の主な変更

1. **Worker 設定を useEffect 内に移動**

   - モジュールレベルでの実行を避け、コンポーネントのマウント時に実行
   - `window`オブジェクトが確実に利用可能になってから設定

2. **詳細なデバッグログの追加**

   - すべての重要なポイントで絵文字付きログを出力
   - バージョン番号`[v3.0]`を含めて識別しやすく

3. **エラーハンドリングの強化**
   - Worker 設定自体の try-catch を追加

---

## 📋 iPad で確認すべきコンソールログ

### ✅ 正常な場合（期待されるログ v3.1）

```javascript
🎬🎬🎬 [v3.0] PdfViewer コンポーネント初期化
🎬🎬🎬 [v3.0] 修正版が適用されています
🔧🔧🔧 [v3.0] PDF.js Worker設定成功: http://192.168.1.64:3000/pdfjs/pdf.worker.min.mjs
🔧🔧🔧 [v3.0] PDF.js version: 4.8.69
⚙️⚙️⚙️ [v3.0] PDF.js オプション設定: { verbosity: 5, ... }

📍📍📍 [v3.0] レンダリング時の状態: { ... }
📂📂📂 [v3.0] タブ変更 useEffect 実行 { ... }
📄📄📄 [v3.0] ファイルタイプ判定: pdf { ... }
📕📕📕 [v3.0] PDFファイルとして処理
📍📍📍 [v3.0] レンダリング時の状態: { ... }

🔄🔄🔄 [v3.0] PDF表示モードでレンダリング: { pdfKey, currentPdf, ... }
��� [v3.0] PDF読み込み開始: http://...
⏳⏳⏳ [v3.0] PDF読み込み進捗: { loaded: 1024, total: 102400, percent: "1.0%" }
⏳⏳⏳ [v3.0] PDF読み込み進捗: { loaded: 10240, total: 102400, percent: "10.0%" }
...
⏳⏳⏳ [v3.0] PDF読み込み進捗: { loaded: 102400, total: 102400, percent: "100.0%" }

✅✅✅ [v3.0] PDF読み込み成功: http://... ページ数: 12
✅✅✅ [v3.0] PDF詳細: { url: "...", numPages: 12, ... }
```

### ❌ エラーの場合（調査が必要）

以下のログが**出ない**場合、その前のステップで問題が発生しています:

1. `🎬🎬🎬 [v3.0]` が出ない
   → PdfViewer コンポーネント自体が読み込まれていない

2. `🔧🔧🔧 [v3.0]` が出ない
   → useEffect が実行されていない、または Worker 設定でエラー

3. `📍📍📍 [v3.0]` が出ない
   → コンポーネントがレンダリングされていない

4. `📂📂📂 [v3.0]` が出ない
   → タブ変更の useEffect が実行されていない

5. `✅✅✅ [v3.0]` が出ない（`📕📕📕`は出る）【v3.1 で詳細診断可能】
   → PDF.js の読み込みが開始されたが失敗している
   → 以下のログで失敗ポイントを特定：
   - `🚀🚀🚀` がない → Document コンポーネントが render されていない
   - `🚀🚀🚀` はあるが `⏳⏳⏳` がない → PDF 読み込みが開始されない（Worker 問題？）
   - `⏳⏳⏳` はあるが途中で止まる → ネットワークエラー、メモリ不足など
   - `⏳⏳⏳` が 100%になるが `✅✅✅` がない → PDF.js 内部でパース失敗
     → `❌❌❌`エラーログを確認

---

## 🔧 確認手順

### Step 1: ブラウザを完全にクリア

**iPad で:**

1. Safari を完全に終了（アプリスイッチャーから削除）
2. 設定 → Safari → 履歴と Web サイトデータを消去
3. iPad を再起動（推奨）

### Step 2: 開発サーバーを再起動

**PC で:**

```bash
# サーバーを停止（Ctrl+C）

# サーバーを再起動
npm run dev
```

### Step 3: iPad で再度アクセス

1. Safari で `http://192.168.1.64:3000` を開く
2. テストを選択して PDF ビューアを開く
3. **すぐに** Mac で Safari → 開発 → [iPad] → コンソールを開く

### Step 4: コンソールログを確認

- `[v3.0]` のログがあるか確認
- どこまでログが出ているか確認
- エラーメッセージがあるか確認

---

## 🐛 ログ別のトラブルシューティング

### ケース 1: `🎬🎬🎬` が表示されない

**原因**: PdfViewer コンポーネントが読み込まれていない

**確認事項**:

- ビルドエラーがないか: `npx next build`
- TestList から正しく PdfViewer が呼ばれているか
- ブラウザの JavaScript が有効か

### ケース 2: `🔧🔧🔧` が表示されない

**原因**: useEffect が実行されていない、または即座にエラー

**確認事項**:

- `❌❌❌ [v3.0] Worker設定エラー:` のログがあるか
- React がクラッシュしていないか
- コンソールに他のエラーがないか

### ケース 3: `📕📕📕` が表示されるが `✅✅✅` が表示されない

**原因**: PDF.js の読み込みが失敗している

**確認事項**:

1. Worker ファイルに直接アクセスできるか
   - `http://192.168.1.64:3000/pdfjs/pdf.worker.min.mjs`
2. PDF ファイルに直接アクセスできるか

   - `http://192.168.1.64:3000/api/pdf/pdfs/XXX.pdf`

3. `❌❌❌ PDF読み込みエラー:` のログを確認

   - エラーメッセージを記録

4. ネットワークタブでリクエストの状態を確認
   - 200 OK が返っているか
   - Content-Type が正しいか

### ケース 4: すべてのログが出るが画面が真っ白

**原因**: レンダリングエラー

**確認事項**:

- React のエラー境界でキャッチされていないか
- `error` ステートに値が入っていないか
- CSS の問題がないか

---

## 📞 情報収集テンプレート

エラーが解決しない場合、以下の情報を提供してください:

```
【iPadデバイス情報】
- モデル:
- iOSバージョン:
- Safariバージョン:

【コンソールログ】
（すべてのログをコピー＆ペースト）

【表示されたログ】
- 🎬🎬🎬: [ ] 表示される / [ ] 表示されない
- 🔧🔧🔧: [ ] 表示される / [ ] 表示されない
- 📍📍📍: [ ] 表示される / [ ] 表示されない
- 📂📂📂: [ ] 表示される / [ ] 表示されない
- 📕📕📕: [ ] 表示される / [ ] 表示されない
- ✅✅✅: [ ] 表示される / [ ] 表示されない

【エラーメッセージ】
（もしあれば）

【直接アクセスの結果】
- Workerファイル: [ ] 表示される / [ ] エラー
- PDFファイル: [ ] 表示される / [ ] エラー
```

---

## 🎯 次のステップ

1. 上記の手順で iPad でテスト
2. コンソールログを確認
3. どこまでログが出ているかを報告
4. エラーがあればエラーメッセージを報告

これにより、問題の箇所を特定できます。

---

**作成日**: 2025 年 11 月 6 日  
**バージョン**: 3.0  
**ステータス**: ⏳ iPad 実機テスト待ち
