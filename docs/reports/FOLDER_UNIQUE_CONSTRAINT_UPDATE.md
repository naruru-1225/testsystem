# ãƒ•ã‚©ãƒ«ãƒ€åŒååˆ¶ç´„ã®å¤‰æ›´é©ç”¨ã‚¬ã‚¤ãƒ‰ (å®Œå…¨ç‰ˆ)

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0  
**æ›´æ–°æ—¥**: 2025-01-XX  
**å¤‰æ›´å†…å®¹**: å…¨ 5 ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£ã‚’å«ã‚€å®Œå…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

---

## ğŸ“ å¤‰æ›´å†…å®¹

è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒç•°ãªã‚‹å ´åˆã€åŒåãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

### å¤‰æ›´å‰

```
ãƒ•ã‚©ãƒ«ãƒ€/
â”œâ”€â”€ ãƒ†ã‚¹ãƒˆç”¨/        â† ä½œæˆå¯èƒ½
â””â”€â”€ è¦ªãƒ•ã‚©ãƒ«ãƒ€A/
    â””â”€â”€ ãƒ†ã‚¹ãƒˆç”¨/    â† ã‚¨ãƒ©ãƒ¼(åŒåã®ãŸã‚NG)
```

### å¤‰æ›´å¾Œ

```
ãƒ•ã‚©ãƒ«ãƒ€/
â”œâ”€â”€ ãƒ†ã‚¹ãƒˆç”¨/        â† ä½œæˆå¯èƒ½
â””â”€â”€ è¦ªãƒ•ã‚©ãƒ«ãƒ€A/
    â””â”€â”€ ãƒ†ã‚¹ãƒˆç”¨/    â† ä½œæˆå¯èƒ½(è¦ªãŒé•ã†ã®ã§OK!)
```

---

## ğŸš¨ é‡è¦: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ã®ä¿®æ­£ãŒå¿…è¦

ã“ã®å¤‰æ›´ã§ã¯ã€**5 ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«**ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

1. **folders** ãƒ†ãƒ¼ãƒ–ãƒ« - UNIQUE åˆ¶ç´„ã®å¤‰æ›´
2. **tests** ãƒ†ãƒ¼ãƒ–ãƒ« - `folders_old` ã¸ã®å‚ç…§ã‚’ä¿®æ­£
3. **test_folders** ãƒ†ãƒ¼ãƒ–ãƒ« - `tests_backup` ã¨ `folders_old` ã¸ã®å‚ç…§ã‚’ä¿®æ­£
4. **test_tags** ãƒ†ãƒ¼ãƒ–ãƒ« - `tests_backup` ã¸ã®å‚ç…§ã‚’ä¿®æ­£
5. **test_attachments** ãƒ†ãƒ¼ãƒ–ãƒ« - `tests_backup` ã¸ã®å‚ç…§ã‚’ä¿®æ­£

---

## ğŸ› ï¸ é©ç”¨æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆ

```powershell
# ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ«ãƒ€å…¨ä½“ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
Copy-Item -Path "data" -Destination "data_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')" -Recurse
```

### ã‚¹ãƒ†ãƒƒãƒ— 2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åœæ­¢

```powershell
# Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
# Ctrl+C ã¾ãŸã¯ ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
```

### ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼:

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(5 å€‹)

- `migrate-folder-unique-constraint.mjs` - folders ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¶ç´„å¤‰æ›´
- `fix-tests-foreign-key.mjs` - tests ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
- `fix-test-folders-foreign-key.mjs` - test_folders ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
- `fix-test-tags-foreign-key.mjs` - test_tags ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
- `fix-test-attachments-foreign-key.mjs` - test_attachments ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£

#### æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ(2 å€‹)

- `verify-migration.mjs` - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨¼
- `test-folder-uniqueness.mjs` - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

#### API ãƒ•ã‚¡ã‚¤ãƒ«(2 å€‹)

- `app/api/folders/route.ts` - ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ API
- `app/api/folders/[id]/route.ts` - ãƒ•ã‚©ãƒ«ãƒ€æ›´æ–° API

#### ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«

- `lib/schema.sql` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### ã‚¹ãƒ†ãƒƒãƒ— 4: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

**âš ï¸ å¿…ãšã“ã®é †ç•ªã§å®Ÿè¡Œã—ã¦ãã ã•ã„:**

```powershell
# 1. foldersãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¶ç´„å¤‰æ›´
node migrate-folder-unique-constraint.mjs

# 2. testsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
node fix-tests-foreign-key.mjs

# 3. test_foldersãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
node fix-test-folders-foreign-key.mjs

# 4. test_tagsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
node fix-test-tags-foreign-key.mjs

# 5. test_attachmentsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£
node fix-test-attachments-foreign-key.mjs
```

### ã‚¹ãƒ†ãƒƒãƒ— 5: æ¤œè¨¼

```powershell
# ã™ã¹ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãé©ç”¨ã•ã‚ŒãŸã‹æ¤œè¨¼
node verify-migration.mjs
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**

```
âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
==================================================
[ãƒ†ã‚¹ãƒˆ1] folders_oldã¸ã®å‚ç…§ãƒã‚§ãƒƒã‚¯
  âœ… å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å‚ç…§ãªã—
[ãƒ†ã‚¹ãƒˆ2] foldersãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¶ç´„ç¢ºèª
  âœ… UNIQUE(name, parent_id)åˆ¶ç´„ã‚ã‚Š
[ãƒ†ã‚¹ãƒˆ3] testsãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ç¢ºèª
  âœ… testsãƒ†ãƒ¼ãƒ–ãƒ«: FOREIGN KEY â†’ folders
[ãƒ†ã‚¹ãƒˆ4] test_foldersãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ç¢ºèª
  âœ… test_foldersãƒ†ãƒ¼ãƒ–ãƒ«: FOREIGN KEY â†’ tests, folders
[ãƒ†ã‚¹ãƒˆ5] æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèª
  âœ… æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€å­˜åœ¨ (ID: X)
[ãƒ†ã‚¹ãƒˆ6] åŒåãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆãƒ†ã‚¹ãƒˆ
  âœ… ç•°ãªã‚‹è¦ªã§ã®åŒåãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ: æˆåŠŸ
  âœ… åŒã˜è¦ªã§ã®åŒåãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ: æ­£ã—ãã‚¨ãƒ©ãƒ¼
==================================================
ğŸ‰ ã™ã¹ã¦ã®æ¤œè¨¼ã«åˆæ ¼ã—ã¾ã—ãŸ!
âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­£å¸¸ã«å®Œäº†ã—ã¦ã„ã¾ã™
âœ… ãƒ†ã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã¯ãšã§ã™
```

### ã‚¹ãƒ†ãƒƒãƒ— 6: æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

```powershell
# ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
node test-folder-uniqueness.mjs
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**

```
ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ!
âœ“ åŒã˜è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ã§ã®åŒåãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚’æ‹’å¦
âœ“ ç•°ãªã‚‹è¦ªãƒ•ã‚©ãƒ«ãƒ€ã§ã®åŒåãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚’è¨±å¯
âœ“ ãƒ«ãƒ¼ãƒˆéšå±¤ã§ã®åŒåãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚’æ‹’å¦
```

### ã‚¹ãƒ†ãƒƒãƒ— 7: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•

```powershell
npm run dev
```

### ã‚¹ãƒ†ãƒƒãƒ— 8: å‹•ä½œç¢ºèª

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã‚’é–‹ã
2. ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ:
   - è¦ªãƒ•ã‚©ãƒ«ãƒ€ A ã®ä¸‹ã«ã€Œãƒ†ã‚¹ãƒˆç”¨ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ â†’ æˆåŠŸ
   - è¦ªãƒ•ã‚©ãƒ«ãƒ€ B ã®ä¸‹ã«ã€Œãƒ†ã‚¹ãƒˆç”¨ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ â†’ æˆåŠŸ(åŒå OK)
   - è¦ªãƒ•ã‚©ãƒ«ãƒ€ A ã®ä¸‹ã«ã‚‚ã†ä¸€åº¦ã€Œãƒ†ã‚¹ãƒˆç”¨ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ â†’ ã‚¨ãƒ©ãƒ¼(åŒã˜è¦ªã®ä¸‹ã¯ NG)
3. ãƒ†ã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã‚’ç¢ºèª:
   - æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ â†’ ã€Œãƒ†ã‚¹ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèª

---

## âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "no such table: main.folders_old"

**åŸå› **: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€”ä¸­ã§ä¸­æ–­ã•ã‚ŒãŸã€ã¾ãŸã¯ä¸€éƒ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿å®Ÿè¡Œã•ã‚ŒãŸ

**è§£æ±ºæ–¹æ³•**:

```powershell
# 1. æ®‹ã£ã¦ã„ã‚‹å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ã‚’ç¢ºèª
node -e "const db=require('better-sqlite3')('data/tests.db');db.prepare('SELECT name,sql FROM sqlite_master WHERE sql LIKE \"%folders_old%\" OR sql LIKE \"%tests_backup%\"').all().forEach(t=>console.log(t.name,t.sql))"

# 2. è©²å½“ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œ
# tests ãƒ†ãƒ¼ãƒ–ãƒ«ã«å•é¡ŒãŒã‚ã‚‹å ´åˆ:
node fix-tests-foreign-key.mjs

# test_folders ãƒ†ãƒ¼ãƒ–ãƒ«ã«å•é¡ŒãŒã‚ã‚‹å ´åˆ:
node fix-test-folders-foreign-key.mjs

# test_tags ãƒ†ãƒ¼ãƒ–ãƒ«ã«å•é¡ŒãŒã‚ã‚‹å ´åˆ:
node fix-test-tags-foreign-key.mjs

# test_attachments ãƒ†ãƒ¼ãƒ–ãƒ«ã«å•é¡ŒãŒã‚ã‚‹å ´åˆ:
node fix-test-attachments-foreign-key.mjs
```

### ã‚¨ãƒ©ãƒ¼: "UNIQUE constraint failed"

ã“ã‚Œã¯æ­£å¸¸ãªå‹•ä½œã§ã™ã€‚åŒã˜è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ã«åŒåã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ãŸå ´åˆã«ç™ºç”Ÿã—ã¾ã™ã€‚

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ãŸå ´åˆ

```powershell
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
# Ctrl+C

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¾©å…ƒ
Remove-Item data\tests.db
Copy-Item data_backup_YYYYMMDD_HHMMSS\tests.db data\tests.db

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
npm run dev
```

---

## ğŸ“‹ å®Œå…¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

é©ç”¨å‰ã«å¿…ãšç¢ºèªã—ã¦ãã ã•ã„:

- [ ] ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ãŸ
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ãŸ
- [ ] ã™ã¹ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(5 å€‹)ã‚’é…ç½®ã—ãŸ
- [ ] æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(2 å€‹)ã‚’é…ç½®ã—ãŸ
- [ ] API ãƒ•ã‚¡ã‚¤ãƒ«(2 å€‹)ã‚’é…ç½®ã—ãŸ
- [ ] ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ãŸ
- [ ] `migrate-folder-unique-constraint.mjs` ã‚’å®Ÿè¡Œã—ãŸ
- [ ] `fix-tests-foreign-key.mjs` ã‚’å®Ÿè¡Œã—ãŸ
- [ ] `fix-test-folders-foreign-key.mjs` ã‚’å®Ÿè¡Œã—ãŸ
- [ ] `fix-test-tags-foreign-key.mjs` ã‚’å®Ÿè¡Œã—ãŸ
- [ ] `fix-test-attachments-foreign-key.mjs` ã‚’å®Ÿè¡Œã—ãŸ
- [ ] `verify-migration.mjs` ã§æ¤œè¨¼ã—ãŸ(ã™ã¹ã¦ âœ… ã«ãªã£ãŸ)
- [ ] `test-folder-uniqueness.mjs` ã§ãƒ†ã‚¹ãƒˆã—ãŸ(ã™ã¹ã¦æˆåŠŸ)
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ãŸ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèªã—ãŸ
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸ

---

## ğŸ“Š æŠ€è¡“è©³ç´°

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´

#### folders ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- å¤‰æ›´å‰
CREATE TABLE folders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL UNIQUE,  -- â† ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯
  parent_id INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (parent_id) REFERENCES folders (id) ON DELETE CASCADE
)

-- å¤‰æ›´å¾Œ
CREATE TABLE folders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,  -- â† UNIQUEã‚’å‰Šé™¤
  parent_id INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (parent_id) REFERENCES folders (id) ON DELETE CASCADE,
  UNIQUE(name, parent_id)  -- â† è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯
)
```

#### tests ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ä¿®æ­£å‰
FOREIGN KEY (folder_id) REFERENCES "folders_old" (id) ON DELETE CASCADE

-- ä¿®æ­£å¾Œ
FOREIGN KEY (folder_id) REFERENCES folders (id) ON DELETE CASCADE
```

#### test_folders ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ä¿®æ­£å‰
FOREIGN KEY (test_id) REFERENCES "tests_backup" (id) ON DELETE CASCADE
FOREIGN KEY (folder_id) REFERENCES "folders_old" (id) ON DELETE CASCADE

-- ä¿®æ­£å¾Œ
FOREIGN KEY (test_id) REFERENCES tests (id) ON DELETE CASCADE
FOREIGN KEY (folder_id) REFERENCES folders (id) ON DELETE CASCADE
```

#### test_tags ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ä¿®æ­£å‰
FOREIGN KEY (test_id) REFERENCES "tests_backup" (id) ON DELETE CASCADE

-- ä¿®æ­£å¾Œ
FOREIGN KEY (test_id) REFERENCES tests (id) ON DELETE CASCADE
```

#### test_attachments ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ä¿®æ­£å‰
FOREIGN KEY (test_id) REFERENCES "tests_backup" (id) ON DELETE CASCADE

-- ä¿®æ­£å¾Œ
FOREIGN KEY (test_id) REFERENCES tests (id) ON DELETE CASCADE
```

### API å¤‰æ›´

#### POST /api/folders (ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ)

```typescript
// è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ã§ã®åŒåãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
const checkStmt = db.prepare(
  "SELECT id FROM folders WHERE name = ? AND parent_id IS ?"
);
const existing = checkStmt.get(name, parentId);

if (existing) {
  return NextResponse.json(
    { error: "åŒã˜è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ã«åŒåã®ãƒ•ã‚©ãƒ«ãƒ€ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™" },
    { status: 400 }
  );
}
```

#### PUT /api/folders/[id] (ãƒ•ã‚©ãƒ«ãƒ€æ›´æ–°)

```typescript
// è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã—ãŸåŒåãƒã‚§ãƒƒã‚¯
const checkStmt = db.prepare(
  "SELECT id FROM folders WHERE name = ? AND parent_id IS ? AND id != ?"
);
const duplicateFolder = checkStmt.get(name, parentId, folderId);

if (duplicateFolder) {
  return NextResponse.json(
    { error: "åŒã˜è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ã«åŒåã®ãƒ•ã‚©ãƒ«ãƒ€ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™" },
    { status: 400 }
  );
}
```

---

## ğŸ”§ ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

1. **migrate-folder-unique-constraint.mjs**

   - folders ãƒ†ãƒ¼ãƒ–ãƒ«ã® UNIQUE åˆ¶ç´„ã‚’å¤‰æ›´
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¦ãƒ‹ãƒ¼ã‚¯ â†’ è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…ãƒ¦ãƒ‹ãƒ¼ã‚¯

2. **fix-tests-foreign-key.mjs**

   - tests ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¿®æ­£
   - folders_old â†’ folders ã«å¤‰æ›´

3. **fix-test-folders-foreign-key.mjs**

   - test_folders ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¿®æ­£
   - tests_backup â†’ tests ã«å¤‰æ›´
   - folders_old â†’ folders ã«å¤‰æ›´

4. **fix-test-tags-foreign-key.mjs**

   - test_tags ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¿®æ­£
   - tests_backup â†’ tests ã«å¤‰æ›´

5. **fix-test-attachments-foreign-key.mjs**
   - test_attachments ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¿®æ­£
   - tests_backup â†’ tests ã«å¤‰æ›´

### ãƒ‡ãƒãƒƒã‚°ãƒ»æ¤œè¨¼ãƒ„ãƒ¼ãƒ«

6. **verify-migration.mjs**

   - ã™ã¹ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãé©ç”¨ã•ã‚ŒãŸã‹æ¤œè¨¼
   - 6 ã¤ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
   - å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ã®æœ‰ç„¡ã‚’ç¢ºèª

7. **test-folder-uniqueness.mjs**
   - ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆæ©Ÿèƒ½ã®å‹•ä½œãƒ†ã‚¹ãƒˆ
   - 3 ã¤ã®ã‚·ãƒŠãƒªã‚ªã‚’ãƒ†ã‚¹ãƒˆ

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

### æ­£å¸¸ã«ä½œæˆã§ãã‚‹ä¾‹

```typescript
// ã‚±ãƒ¼ã‚¹1: ç•°ãªã‚‹è¦ªãƒ•ã‚©ãƒ«ãƒ€
è¦ªA/ãƒ†ã‚¹ãƒˆç”¨/  â† OK
è¦ªB/ãƒ†ã‚¹ãƒˆç”¨/  â† OK (è¦ªãŒé•ã†ã®ã§è¨±å¯)

// ã‚±ãƒ¼ã‚¹2: ãƒ«ãƒ¼ãƒˆéšå±¤ã¨å­éšå±¤
/ãƒ†ã‚¹ãƒˆç”¨/      â† OK
/è¦ªA/ãƒ†ã‚¹ãƒˆç”¨/  â† OK (éšå±¤ãŒé•ã†ã®ã§è¨±å¯)
```

### ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ä¾‹

```typescript
// ã‚±ãƒ¼ã‚¹1: åŒã˜è¦ªãƒ•ã‚©ãƒ«ãƒ€å†…
è¦ªA/ãƒ†ã‚¹ãƒˆç”¨/  â† OK
è¦ªA/ãƒ†ã‚¹ãƒˆç”¨/  â† NG (åŒã˜è¦ªã®ä¸‹ã«åŒåã¯ä¸å¯)

// ã‚±ãƒ¼ã‚¹2: åŒã˜ãƒ«ãƒ¼ãƒˆéšå±¤
/ãƒ†ã‚¹ãƒˆç”¨/     â† OK
/ãƒ†ã‚¹ãƒˆç”¨/     â† NG (åŒã˜ãƒ«ãƒ¼ãƒˆéšå±¤ã«åŒåã¯ä¸å¯)
```

---

## ğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´

### v2.0 (2025-01-XX)

- test_tags ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£ã‚’è¿½åŠ 
- test_attachments ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£ã‚’è¿½åŠ 
- åˆè¨ˆ 5 ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£ã«å¯¾å¿œ
- verify-migration.mjs ã«ã‚ˆã‚‹å®Œå…¨ãªæ¤œè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ 
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ˜ç¢ºåŒ–

### v1.2 (2025-01-XX)

- tests ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£ã‚’è¿½åŠ 
- test_folders ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ä¿®æ­£ã‚’è¿½åŠ 
- "no such table: main.folders_old"ã‚¨ãƒ©ãƒ¼ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ 

### v1.1 (2025-01-XX)

- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †ã®è©³ç´°åŒ–
- test-folder-uniqueness.mjs ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½è¿½åŠ 

### v1.0 (2025-01-XX)

- åˆç‰ˆ: ãƒ•ã‚©ãƒ«ãƒ€ UNIQUE åˆ¶ç´„ã®å¤‰æ›´
- API æ›´æ–°

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:

1. `verify-migration.mjs` ã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
3. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©å…ƒã‚’æ¤œè¨

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å¤‰æ›´é©ç”¨ã‚’å®‰å…¨ã«è¡Œã†ãŸã‚ã®ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚**  
**å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã‹ã‚‰ä½œæ¥­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚**
