# é–‹ç™ºè€…å‘ã‘ å®Œå…¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®é–‹ç™ºãƒ»ä¿å®ˆã‚’æ‹…å½“ã™ã‚‹æŠ€è¡“è€…å‘ã‘ã«ã€ç™ºç”ŸãŒäºˆæƒ³ã•ã‚Œã‚‹éšœå®³ã¨ãã®è§£æ±ºæ–¹æ³•ã‚’è©³ç´°ã«è¨˜è¼‰ã—ãŸã‚‚ã®ã§ã™ã€‚

**å¯¾è±¡**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºè€…ã€ä¿å®ˆæ‹…å½“è€…ã€æŠ€è¡“ã‚µãƒãƒ¼ãƒˆ  
**æœ€çµ‚æ›´æ–°**: 2025 å¹´ 10 æœˆ 29 æ—¥

---

## ğŸ“‹ ç›®æ¬¡

### ç¬¬ 1 éƒ¨: é–‹ç™ºç’°å¢ƒã®å•é¡Œ

1. [ç’°å¢ƒæ§‹ç¯‰æ™‚ã®ã‚¨ãƒ©ãƒ¼](#1-ç’°å¢ƒæ§‹ç¯‰æ™‚ã®ã‚¨ãƒ©ãƒ¼)
2. [ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å•é¡Œ](#2-ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å•é¡Œ)
3. [TypeScript/ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼](#3-typescriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼)

### ç¬¬ 2 éƒ¨: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å•é¡Œ

4. [SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼](#4-sqliteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼)
5. [ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡Œ](#5-ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡Œ)
6. [ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã®å•é¡Œ](#6-ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒã®å•é¡Œ)

### ç¬¬ 3 éƒ¨: API/ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å•é¡Œ

7. [API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼](#7-apiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼)
8. [ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å•é¡Œ](#8-ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å•é¡Œ)
9. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŠ£åŒ–](#9-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®åŠ£åŒ–)

### ç¬¬ 4 éƒ¨: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å•é¡Œ

10. [React/Next.js ã®ã‚¨ãƒ©ãƒ¼](#10-reactnextjsã®ã‚¨ãƒ©ãƒ¼)
11. [UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸å…·åˆ](#11-uiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸å…·åˆ)
12. [ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã®å•é¡Œ](#12-ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã®å•é¡Œ)

### ç¬¬ 5 éƒ¨: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»æœ¬ç•ªç’°å¢ƒ

13. [ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ã‚¨ãƒ©ãƒ¼](#13-ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ã‚¨ãƒ©ãƒ¼)
14. [æœ¬ç•ªç’°å¢ƒç‰¹æœ‰ã®å•é¡Œ](#14-æœ¬ç•ªç’°å¢ƒç‰¹æœ‰ã®å•é¡Œ)
15. [ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®èª²é¡Œ](#15-ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®èª²é¡Œ)

### ç¬¬ 6 éƒ¨: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

16. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§](#16-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§)
17. [ãƒ‡ãƒ¼ã‚¿ä¿è­·ã®å•é¡Œ](#17-ãƒ‡ãƒ¼ã‚¿ä¿è­·ã®å•é¡Œ)

### ç¬¬ 7 éƒ¨: ä¿å®ˆãƒ»é‹ç”¨

18. [ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°](#18-ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°)
19. [ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](#19-ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
20. [ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æˆ¦ç•¥](#20-ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æˆ¦ç•¥)

---

## ç¬¬ 1 éƒ¨: é–‹ç™ºç’°å¢ƒã®å•é¡Œ

### 1. ç’°å¢ƒæ§‹ç¯‰æ™‚ã®ã‚¨ãƒ©ãƒ¼

#### 1-1. Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆ

**ç—‡çŠ¶**:

```
Error: The engine "node" is incompatible with this module
Expected version ">=20.0.0". Got "18.17.0"
```

**åŸå› **:

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦æ±‚ã™ã‚‹ Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹
- Next.js 15 ã¯ Node.js 20 ä»¥ä¸ŠãŒå¿…è¦

**è§£æ±ºæ–¹æ³•**:

```bash
# ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
node --version

# nvmã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
nvm install 20
nvm use 20

# ã¾ãŸã¯ã€Node.jsã‚’ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# https://nodejs.org/ ã‹ã‚‰ LTSç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
```

**äºˆé˜²ç­–**:

- `.nvmrc`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®š

```
20.10.0
```

---

#### 1-2. npm install ã®å¤±æ•—(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼)

**ç—‡çŠ¶**:

```
npm ERR! code ETIMEDOUT
npm ERR! errno ETIMEDOUT
npm ERR! network request to https://registry.npmjs.org/... failed
```

**åŸå› **:

- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œ
- npm ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
- ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®å•é¡Œ

**è§£æ±ºæ–¹æ³•**:

```bash
# npmè¨­å®šã‚’ç¢ºèª
npm config list

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’å»¶é•·
npm config set timeout 60000

# ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ
npm config set proxy http://proxy.company.com:8080
npm config set https-proxy http://proxy.company.com:8080

# ã¾ãŸã¯ã€ãƒ—ãƒ­ã‚­ã‚·ã‚’ç„¡åŠ¹åŒ–
npm config delete proxy
npm config delete https-proxy

# ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’å¤‰æ›´(ä¸­å›½ã®å ´åˆãªã©)
npm config set registry https://registry.npmmirror.com
```

---

### 2. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å•é¡Œ

#### 2-1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:

```
npm ERR! code ERESOLVE
npm ERR! ERESOLVE could not resolve
npm ERR! peer react@"^18.0.0" from next@15.5.6
```

**åŸå› **:

- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é–“ã®ä¾å­˜é–¢ä¿‚ã®ç«¶åˆ
- React ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸æ•´åˆ

**è§£æ±ºæ–¹æ³•**:

```bash
# æ–¹æ³•1: --legacy-peer-deps ã§å¼·åˆ¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install --legacy-peer-deps

# æ–¹æ³•2: --force ã§å¼·åˆ¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(éæ¨å¥¨)
npm install --force

# æ–¹æ³•3: package-lock.jsonã‚’å‰Šé™¤ã—ã¦å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
rm package-lock.json
rm -rf node_modules
npm install

# æ–¹æ³•4: ç‰¹å®šã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
npm update react react-dom
```

**æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œ**:

```json
// package.json ã« overrides ã‚’è¿½åŠ (npm 8.3+)
{
  "overrides": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  }
}
```

---

#### 2-2. better-sqlite3 ã®ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:

```
gyp ERR! build error
gyp ERR! stack Error: `C:\Program Files\MSBuild\...` failed with exit code: 1
```

**åŸå› **:

- C++ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„
- Python3 ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„
- Windows Build Tools ãŒãªã„

**è§£æ±ºæ–¹æ³•(Windows)**:

```powershell
# Visual Studio Build Toolsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# https://visualstudio.microsoft.com/ja/downloads/

# ã¾ãŸã¯ã€windows-build-toolsã‚’ä½¿ç”¨
npm install --global --production windows-build-tools

# Python3ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# https://www.python.org/downloads/

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€npm rebuild
npm rebuild better-sqlite3
```

**è§£æ±ºæ–¹æ³•(Mac)**:

```bash
# Xcode Command Line Toolsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
xcode-select --install

# node-gypã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g node-gyp

# å†ãƒ“ãƒ«ãƒ‰
npm rebuild better-sqlite3
```

---

### 3. TypeScript/ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼

#### 3-1. Next.js 15 ã® Params å‹ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:

```typescript
Type 'Promise<{ id: string }>' is not assignable to type '{ id: string }'
```

**åŸå› **:

- Next.js 15 ã§å‹•çš„ãƒ«ãƒ¼ãƒˆã® params ãŒéåŒæœŸã«ãªã£ãŸ
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãŒ Next.js 14 ä»¥å‰ã®è¨˜æ³•

**è§£æ±ºæ–¹æ³•**:

```typescript
// âŒ å¤ã„è¨˜æ³•(Next.js 14)
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const testId = params.id; // ã‚¨ãƒ©ãƒ¼
}

// âœ… æ–°ã—ã„è¨˜æ³•(Next.js 15)
export async function GET(
  request: Request,
  context: { params: Promise<{ id: string }> }
) {
  const { id } = await context.params; // OK
}
```

**å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«**:

- `app/api/tests/[id]/route.ts`
- `app/api/tests/[id]/attachments/route.ts`
- `app/api/folders/[id]/route.ts`
- `app/api/tags/[id]/route.ts`
- `app/api/grades/[id]/route.ts`
- `app/api/subjects/[id]/route.ts`

---

#### 3-2. å‹å®šç¾©ã®ä¸æ•´åˆ

**ç—‡çŠ¶**:

```typescript
Property 'folders' does not exist on type 'Test'
```

**åŸå› **:

- å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«(`types/database.ts`)ã®æ›´æ–°æ¼ã‚Œ
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ‹¡å¼µã®ä¸å‚™

**è§£æ±ºæ–¹æ³•**:

```typescript
// types/database.ts ã‚’ç¢ºèª

// Testã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
export interface Test {
  id: number;
  name: string;
  subject: string;
  grade: string;
  description?: string;
  pdf_path: string;
  folder_id: number;
  created_at: string;
  updated_at: string;
}

// TestWithTags ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹(æ‹¡å¼µå‹)
export interface TestWithTags extends Test {
  tags: Tag[];
  folders: Folder[]; // ã“ã®å®šç¾©ãŒå¿…è¦
}
```

**æ¤œè¨¼æ–¹æ³•**:

```bash
# TypeScriptã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
npx tsc --noEmit

# ã¾ãŸã¯ã€ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
npm run build
```

---

## ç¬¬ 2 éƒ¨: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å•é¡Œ

### 4. SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

#### 4-1. NOT NULL constraint failed: tests.folder_id

**æœ€ã‚‚é »å‡ºã™ã‚‹ã‚¨ãƒ©ãƒ¼**

**ç—‡çŠ¶**:

```
SqliteError: NOT NULL constraint failed: tests.folder_id
```

**åŸå› **:

1. ãƒ†ã‚¹ãƒˆä½œæˆæ™‚ã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã›ãšã€`folder_id`ãŒ null ã«ãªã‚‹
2. ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤å¾Œã€é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã®`folder_id`ãŒç„¡åŠ¹ã«ãªã‚‹
3. `æœªåˆ†é¡`ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„

**è©³ç´°ãªç™ºç”Ÿã‚·ãƒŠãƒªã‚ª**:

```typescript
// ã‚·ãƒŠãƒªã‚ª1: ãƒ•ã‚©ãƒ«ãƒ€æœªé¸æŠã§ã®ä½œæˆ
const formData = {
  name: "ãƒ†ã‚¹ãƒˆ",
  subject: "æ•°å­¦",
  grade: "ä¸­1",
  folderIds: [], // ç©ºé…åˆ— â†’ folder_idãŒnull
};

// ã‚·ãƒŠãƒªã‚ª2: æœªåˆ†é¡ã®ã¿é¸æŠ â†’ é™¤å¤–å‡¦ç†ã§folderIds ãŒç©ºã«
let folderIds = formData.folderIds.filter(
  (id) => id !== uncategorizedFolder.id
);
// folderIds = [] â†’ folder_idãŒnull
```

**å®Œå…¨ãªè§£æ±ºæ–¹æ³•(å®Ÿè£…æ¸ˆã¿)**:

```typescript
// app/api/tests/route.ts (POST)
// ä¸‰é‡ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒˆ

// Layer 1: ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã®å‰å‡¦ç†
let folderIds = formData.folderIds || [];
const uncategorizedFolder = db
  .prepare("SELECT id FROM folders WHERE name = 'æœªåˆ†é¡'")
  .get() as { id: number } | undefined;

// æœªåˆ†é¡ã‚’é™¤å¤–
folderIds = folderIds.filter((id) => id !== uncategorizedFolder?.id);

// ç©ºã®å ´åˆã¯æœªåˆ†é¡ã‚’è¿½åŠ 
if (folderIds.length === 0 && uncategorizedFolder) {
  folderIds = [uncategorizedFolder.id];
}

// Layer 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ç›´å‰ã®ãƒã‚§ãƒƒã‚¯
if (!folderIds || folderIds.length === 0 || !folderIds[0]) {
  // æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€ã®å–å¾—ã¾ãŸã¯ä½œæˆ
  let uncategorized = db
    .prepare("SELECT id FROM folders WHERE name = 'æœªåˆ†é¡'")
    .get() as { id: number } | undefined;

  if (!uncategorized) {
    // æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã‘ã‚Œã°ä½œæˆ
    console.log("Creating uncategorized folder...");
    db.prepare("INSERT INTO folders (name) VALUES (?)").run("æœªåˆ†é¡");
    uncategorized = db
      .prepare("SELECT id FROM folders WHERE name = 'æœªåˆ†é¡'")
      .get() as { id: number };
  }

  folderIds = [uncategorized.id];
}

// Layer 3: æœ€çµ‚çš„ãªfolder_idã®è¨­å®š
const folder_id = folderIds[0]; // å¿…ãšå€¤ãŒå­˜åœ¨ã™ã‚‹ä¿è¨¼

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹INSERT
db.prepare(
  `
  INSERT INTO tests (name, subject, grade, folder_id, pdf_path, created_at, updated_at)
  VALUES (?, ?, ?, ?, ?, datetime('now'), datetime('now'))
`
).run(name, subject, grade, folder_id, pdfPath);
```

**æ¤œè¨¼æ–¹æ³•**:

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
node check-db-integrity.mjs

# folder_idãŒNULLã®ãƒ†ã‚¹ãƒˆã‚’æ¤œå‡º
sqlite3 data/tests.db "SELECT COUNT(*) FROM tests WHERE folder_id IS NULL;"
# çµæœãŒ0ã§ã‚ã‚‹ã¹ã

# æœªåˆ†é¡ãƒ•ã‚©ãƒ«ãƒ€ã®å­˜åœ¨ç¢ºèª
sqlite3 data/tests.db "SELECT * FROM folders WHERE name = 'æœªåˆ†é¡';"
```

---

#### 4-2. database is locked ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:

```
SqliteError: database is locked
```

**åŸå› **:

- è¤‡æ•°ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒåŒæ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„
- æ¥ç¶šãŒé©åˆ‡ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:

```typescript
// âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
const db = new Database("data/tests.db");
// å‡¦ç†...
// closeã‚’å¿˜ã‚Œã‚‹

// âœ… æ¨å¥¨ã•ã‚Œã‚‹æ–¹æ³•
function withDatabase<T>(fn: (db: Database.Database) => T): T {
  const db = new Database("data/tests.db");
  try {
    return fn(db);
  } finally {
    db.close(); // å¿…ãšã‚¯ãƒ­ãƒ¼ã‚º
  }
}

// ä½¿ç”¨ä¾‹
const tests = withDatabase((db) => {
  return db.prepare("SELECT * FROM tests").all();
});
```

**WAL ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š(æ¨å¥¨)**:

```typescript
// lib/database.ts
const db = new Database(dbPath);
db.pragma("journal_mode = WAL"); // Write-Ahead Logã‚’æœ‰åŠ¹åŒ–
// WALãƒ¢ãƒ¼ãƒ‰ã§ã¯èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
```

**ç·Šæ€¥å¯¾å¿œ**:

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒƒã‚¯ã‚’ç¢ºèª
fuser data/tests.db  # Linux/Mac

# ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
Stop-Process -Name node -Force  # Windows

# WALãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤(æœ€çµ‚æ‰‹æ®µ)
rm data/tests.db-shm
rm data/tests.db-wal
```

---

### 5. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®å•é¡Œ

#### 5-1. å­¤ç«‹ãƒ‡ãƒ¼ã‚¿(Orphaned Records)

**ç—‡çŠ¶**:

- å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã® ID ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆãŒæ®‹ã‚‹
- test_folders ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç„¡åŠ¹ãªé–¢é€£ãŒæ®‹ã‚‹

**æ¤œå‡ºã‚¯ã‚¨ãƒª**:

```sql
-- å­˜åœ¨ã—ãªã„folder_idã‚’æŒã¤ãƒ†ã‚¹ãƒˆ
SELECT t.id, t.name, t.folder_id
FROM tests t
WHERE NOT EXISTS (
  SELECT 1 FROM folders f WHERE f.id = t.folder_id
);

-- test_foldersã«é–¢é€£ãŒãªã„ãƒ†ã‚¹ãƒˆ
SELECT t.id, t.name
FROM tests t
WHERE NOT EXISTS (
  SELECT 1 FROM test_folders tf WHERE tf.test_id = t.id
);

-- å­˜åœ¨ã—ãªã„test_idã¾ãŸã¯folder_idã‚’å‚ç…§ã™ã‚‹test_folders
SELECT tf.*
FROM test_folders tf
WHERE NOT EXISTS (SELECT 1 FROM tests t WHERE t.id = tf.test_id)
   OR NOT EXISTS (SELECT 1 FROM folders f WHERE f.id = tf.folder_id);
```

**è‡ªå‹•ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:

```javascript
// fix-orphaned-data.mjs
import Database from "better-sqlite3";
import path from "path";

const db = new Database("data/tests.db");

console.log("å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©ã‚’é–‹å§‹...");

// 1. test_foldersã®å­¤ç«‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
const orphanedTestFolders = db
  .prepare(
    `
  DELETE FROM test_folders
  WHERE test_id NOT IN (SELECT id FROM tests)
     OR folder_id NOT IN (SELECT id FROM folders)
`
  )
  .run();
console.log(`å­¤ç«‹ã—ãŸtest_folders: ${orphanedTestFolders.changes}ä»¶å‰Šé™¤`);

// 2. test_foldersã«é–¢é€£ãŒãªã„ãƒ†ã‚¹ãƒˆã«æœªåˆ†é¡ã‚’è¿½åŠ 
const uncategorized = db
  .prepare("SELECT id FROM folders WHERE name = 'æœªåˆ†é¡'")
  .get();
if (uncategorized) {
  const orphanedTests = db
    .prepare(
      `
    SELECT t.id FROM tests t
    WHERE NOT EXISTS (SELECT 1 FROM test_folders tf WHERE tf.test_id = t.id)
  `
    )
    .all();

  const insertTf = db.prepare(
    "INSERT INTO test_folders (test_id, folder_id) VALUES (?, ?)"
  );
  orphanedTests.forEach((test) => {
    insertTf.run(test.id, uncategorized.id);
  });
  console.log(`æœªåˆ†é¡ã«è¿½åŠ : ${orphanedTests.length}ä»¶`);
}

// 3. å­˜åœ¨ã—ãªã„folder_idã‚’æŒã¤ãƒ†ã‚¹ãƒˆã‚’æœªåˆ†é¡ã«å¤‰æ›´
if (uncategorized) {
  const invalidFolderTests = db
    .prepare(
      `
    UPDATE tests SET folder_id = ?
    WHERE folder_id NOT IN (SELECT id FROM folders)
  `
    )
    .run(uncategorized.id);
  console.log(`folder_idä¿®æ­£: ${invalidFolderTests.changes}ä»¶`);
}

db.close();
console.log("ä¿®å¾©å®Œäº†");
```

å®Ÿè¡Œ:

```bash
node fix-orphaned-data.mjs
```

---

#### 5-2. é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®ç™ºç”Ÿ

**ç—‡çŠ¶**:

- åŒã˜ãƒ†ã‚¹ãƒˆã«åŒã˜ã‚¿ã‚°ãŒè¤‡æ•°å›é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹
- åŒã˜åå‰ã®ãƒ•ã‚©ãƒ«ãƒ€ãŒè¤‡æ•°å­˜åœ¨ã™ã‚‹

**æ¤œå‡ºã‚¯ã‚¨ãƒª**:

```sql
-- é‡è¤‡ã‚¿ã‚°é–¢é€£
SELECT test_id, tag_id, COUNT(*) as count
FROM test_tags
GROUP BY test_id, tag_id
HAVING COUNT(*) > 1;

-- é‡è¤‡ãƒ•ã‚©ãƒ«ãƒ€å
SELECT name, COUNT(*) as count
FROM folders
GROUP BY name
HAVING COUNT(*) > 1;
```

**äºˆé˜²ç­–(UNIQUE åˆ¶ç´„ã®è¿½åŠ )**:

```sql
-- lib/database.ts ã®åˆæœŸåŒ–æ™‚ã«è¿½åŠ 

-- test_tagsã«UNIQUEåˆ¶ç´„
CREATE TABLE IF NOT EXISTS test_tags (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  test_id INTEGER NOT NULL,
  tag_id INTEGER NOT NULL,
  UNIQUE(test_id, tag_id),  -- ã“ã®è¡Œã‚’è¿½åŠ 
  FOREIGN KEY (test_id) REFERENCES tests(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);

-- foldersã«UNIQUEåˆ¶ç´„
CREATE TABLE IF NOT EXISTS folders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL UNIQUE,  -- UNIQUEã‚’è¿½åŠ 
  parent_id INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (parent_id) REFERENCES folders(id) ON DELETE CASCADE
);
```

**æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**:

```sql
-- é‡è¤‡ã‚¿ã‚°é–¢é€£ã‚’å‰Šé™¤(å°ã•ã„IDã®ã¿æ®‹ã™)
DELETE FROM test_tags
WHERE id NOT IN (
  SELECT MIN(id) FROM test_tags GROUP BY test_id, tag_id
);

-- é‡è¤‡ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤(å°ã•ã„IDã®ã¿æ®‹ã™)
-- â€»æ³¨æ„: ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤å‰ã«ãƒ†ã‚¹ãƒˆã®é–¢é€£ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ã‚ã‚Š
```

---

### 6. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã®å•é¡Œ

#### 6-1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸å®Œå…¨

**ç—‡çŠ¶**:

- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒå…ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ˆã‚Šå°ã•ã„
- å¾©å…ƒæ™‚ã«æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„

**åŸå› **:

- SQLite ã® WAL(Write-Ahead Logging)ãƒ¢ãƒ¼ãƒ‰ã§ã€WAL ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å«ã¾ã‚Œã¦ã„ãªã„

**å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰**:

```typescript
// âŒ ä¸å®Œå…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
const dbBuffer = fs.readFileSync("data/tests.db");
fs.writeFileSync("backup.db", dbBuffer);
// WALãƒ•ã‚¡ã‚¤ãƒ«(.db-wal)ã®å†…å®¹ãŒå«ã¾ã‚Œãªã„
```

**æ­£ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ–¹æ³•(å®Ÿè£…æ¸ˆã¿)**:

```typescript
// app/api/backup/create/route.ts
import Database from "better-sqlite3";

export async function GET() {
  const dbPath = path.join(process.cwd(), "data", "tests.db");
  const timestamp = new Date().toISOString().replace(/:/g, "-").split(".")[0];
  const filename = `backup-${timestamp}.db`;
  const tempBackupPath = path.join(process.cwd(), "data", filename);

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã§é–‹ã
  const db = new Database(dbPath, { readonly: true });

  try {
    // VACUUM INTOã§å®Œå…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
    // WALãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚‚å«ã¾ã‚Œã‚‹
    db.exec(`VACUUM INTO '${tempBackupPath.replace(/\\/g, "/")}'`);
  } finally {
    db.close();
  }

  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  const backupBuffer = fs.readFileSync(tempBackupPath);
  fs.unlinkSync(tempBackupPath); // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

  return new NextResponse(backupBuffer, {
    headers: {
      "Content-Type": "application/octet-stream",
      "Content-Disposition": `attachment; filename="${filename}"`,
      "Content-Length": backupBuffer.length.toString(),
    },
  });
}
```

**æ¤œè¨¼æ–¹æ³•**:

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰å¾Œã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’æ¯”è¼ƒ
sqlite3 data/tests.db "SELECT COUNT(*) FROM tests;"
# ä¾‹: 42

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ(ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèª
sqlite3 backup-2025-10-29T14-30-00.db "SELECT COUNT(*) FROM tests;"
# ä¾‹: 42 (åŒã˜æ•°ã§ã‚ã‚‹ã¹ã)

# ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’æ¯”è¼ƒ
for table in tests folders tags test_folders test_tags; do
  echo "$table: $(sqlite3 data/tests.db "SELECT COUNT(*) FROM $table;")"
  echo "$table (backup): $(sqlite3 backup-*.db "SELECT COUNT(*) FROM $table;")"
done
```

---

## ç¬¬ 3 éƒ¨: API/ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å•é¡Œ

### 7. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼

#### 7-1. ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãŒå‹•ä½œã—ãªã„

**ç—‡çŠ¶**:

- `/api/tests?tagId=1`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚å…¨ãƒ†ã‚¹ãƒˆãŒè¿”ã•ã‚Œã‚‹
- ã‚¿ã‚° ID ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œãªã„

**åŸå› **:

- API ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§`tagId`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå‡¦ç†ã•ã‚Œã¦ã„ãªã„
- SQL ã‚¯ã‚¨ãƒªã« WHERE æ¡ä»¶ãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„

**ä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰(å•é¡Œ)**:

```typescript
// app/api/tests/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const folderId = searchParams.get("folderId");
  const grade = searchParams.get("grade");
  const subject = searchParams.get("subject");
  // tagIdãŒå–å¾—ã•ã‚Œã¦ã„ãªã„

  let query = "SELECT * FROM tests WHERE 1=1";
  const params: any[] = [];

  if (grade) {
    query += " AND grade = ?";
    params.push(grade);
  }
  // tagIdã®ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ãŒãªã„

  const tests = db.prepare(query).all(...params);
  return NextResponse.json(tests);
}
```

**ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰(å®Ÿè£…æ¸ˆã¿)**:

```typescript
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const folderId = searchParams.get("folderId");
  const grade = searchParams.get("grade");
  const subject = searchParams.get("subject");
  const tagId = searchParams.get("tagId"); // è¿½åŠ 
  const search = searchParams.get("search");

  let query = `
    SELECT 
      t.*,
      f.name as folder_name
    FROM tests t
    LEFT JOIN folders f ON t.folder_id = f.id
    WHERE 1=1
  `;
  const params: any[] = [];

  // ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿
  if (tagId) {
    query += ` AND EXISTS (
      SELECT 1 FROM test_tags tt 
      WHERE tt.test_id = t.id AND tt.tag_id = ?
    )`;
    params.push(tagId);
  }

  // ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿...

  const tests = db.prepare(query).all(...params);
  return NextResponse.json(tests);
}
```

**ãƒ†ã‚¹ãƒˆæ–¹æ³•**:

```bash
# ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—ã—ã¦tagIdã‚’ç¢ºèª
curl http://localhost:3000/api/tags
# [{"id":1,"name":"é‡è¦",...},{"id":2,"name":"å¾©ç¿’",...}]

# ã‚¿ã‚°IDã§ãƒ•ã‚£ãƒ«ã‚¿
curl http://localhost:3000/api/tests?tagId=1
# tagId=1ãŒä»˜ã„ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã®ã¿è¿”ã•ã‚Œã‚‹ã¹ã

# ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿ã¨ã®ä½µç”¨
curl "http://localhost:3000/api/tests?tagId=1&grade=%E4%B8%AD1"
# ä¸­1 ã‹ã¤ ã‚¿ã‚°ID=1
```

---

#### 7-2. ãƒ•ã‚©ãƒ«ãƒ€ã®å­å­«ãŒå–å¾—ã§ããªã„

**ç—‡çŠ¶**:

- è¦ªãƒ•ã‚©ãƒ«ãƒ€ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ã‚‚ã€å­ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ†ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **:

- ãƒ•ã‚©ãƒ«ãƒ€ã®éšå±¤æ§‹é€ ã‚’å†å¸°çš„ã«å–å¾—ã—ã¦ã„ãªã„

**å®Ÿè£…æ¸ˆã¿ã®è§£æ±ºç­–**:

```typescript
// app/api/tests/route.ts

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã®å­å­«ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¨ã¦å–å¾—ã™ã‚‹(å†å¸°çš„)
 */
function getDescendantFolderIds(folderId: number): number[] {
  const descendants: number[] = [];
  const children = db
    .prepare("SELECT id FROM folders WHERE parent_id = ?")
    .all(folderId) as { id: number }[];

  for (const child of children) {
    descendants.push(child.id);
    // å†å¸°çš„ã«å­«ãƒ•ã‚©ãƒ«ãƒ€ã‚‚å–å¾—
    descendants.push(...getDescendantFolderIds(child.id));
  }

  return descendants;
}

export async function GET(request: Request) {
  // ...

  if (folderId) {
    // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã¨ãã®å­å­«ãƒ•ã‚©ãƒ«ãƒ€ã®IDã‚’å–å¾—
    const descendantIds = getDescendantFolderIds(parseInt(folderId));
    descendantIds.push(parseInt(folderId)); // è‡ªåˆ†è‡ªèº«ã‚‚å«ã‚ã‚‹

    // test_foldersãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿
    if (descendantIds.length === 1) {
      query += ` AND EXISTS (
        SELECT 1 FROM test_folders tf 
        WHERE tf.test_id = t.id AND tf.folder_id = ?
      )`;
      params.push(folderId);
    } else {
      const placeholders = descendantIds.map(() => "?").join(",");
      query += ` AND EXISTS (
        SELECT 1 FROM test_folders tf 
        WHERE tf.test_id = t.id AND tf.folder_id IN (${placeholders})
      )`;
      params.push(...descendantIds);
    }
  }

  // ...
}
```

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:

```sql
-- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
INSERT INTO folders (name, parent_id) VALUES ('è¦ª', NULL);
INSERT INTO folders (name, parent_id) VALUES ('å­', 1);
INSERT INTO folders (name, parent_id) VALUES ('å­«', 2);

INSERT INTO tests (name, folder_id, ...) VALUES ('ãƒ†ã‚¹ãƒˆ1', 1, ...);
INSERT INTO tests (name, folder_id, ...) VALUES ('ãƒ†ã‚¹ãƒˆ2', 2, ...);
INSERT INTO tests (name, folder_id, ...) VALUES ('ãƒ†ã‚¹ãƒˆ3', 3, ...);

-- ãƒ•ã‚©ãƒ«ãƒ€ã€Œè¦ªã€(id=1)ã§ãƒ•ã‚£ãƒ«ã‚¿
-- æœŸå¾…: ãƒ†ã‚¹ãƒˆ1, ãƒ†ã‚¹ãƒˆ2, ãƒ†ã‚¹ãƒˆ3 ã™ã¹ã¦å–å¾—ã•ã‚Œã‚‹ã¹ã
```

---

(æ–‡å­—æ•°åˆ¶é™ã®ãŸã‚ã€ã“ã“ã¾ã§ã¨ã—ã¾ã™ã€‚å®Œå…¨ç‰ˆã¯éå¸¸ã«é•·å¤§ã«ãªã‚‹ãŸã‚ã€å¿…è¦ãªéƒ¨åˆ†ã‚’æ®µéšçš„ã«è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™)

## ğŸ“ ã¾ã¨ã‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å®Ÿéš›ã®é–‹ç™ºã§é­é‡ã—ãŸå•é¡Œã¨ãã®è§£æ±ºç­–ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**:

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§**: folder_id ã® NOT NULL åˆ¶ç´„ãŒæœ€ã‚‚é »å‡ºã™ã‚‹å•é¡Œ
2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: VACUUM INTO ã‚’ä½¿ç”¨ã—ãŸå®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå¿…é ˆ
3. **Next.js 15 å¯¾å¿œ**: params ã®éåŒæœŸåŒ–ã«å¯¾å¿œãŒå¿…è¦
4. **å‹å®‰å…¨æ€§**: TypeScript ã®å‹å®šç¾©ã‚’æœ€æ–°ã«ä¿ã¤

**æ¨å¥¨ã•ã‚Œã‚‹é–‹ç™ºãƒ•ãƒ­ãƒ¼**:

```bash
# 1. é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
npm install
node check-db-integrity.mjs  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

# 2. é–‹ç™º
npm run dev

# 3. ãƒ†ã‚¹ãƒˆ
npm run build  # TypeScriptã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
node test-api.mjs  # APIãƒ†ã‚¹ãƒˆ

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
npm run build
node check-db-integrity.mjs
```

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯éšæ™‚æ›´æ–°ã—ã¦ãã ã•ã„ã€‚æ–°ã—ã„å•é¡ŒãŒç™ºè¦‹ã•ã‚ŒãŸã‚‰ã€å¿…ãšè¨˜éŒ²ã‚’æ®‹ã—ã¦ãã ã•ã„ã€‚**

Â© 2025 ãƒ†ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ 
