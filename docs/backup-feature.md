# 自動バックアップ機能

## 概要

テスト管理システムに自動バックアップ機能が実装されました。この機能は、重要なデータを定期的に自動保存し、データ損失のリスクを軽減します。

## 機能詳細

### バックアップのタイミング

- **実行時刻**: 毎日 19:30 (JST)
- **条件**: システムが19:30に起動している場合のみ実行
- **注意**: システムが停止している場合、バックアップは実行されません（キャッチアップは行いません）

### バックアップ対象

以下の2つのフォルダがバックアップされます：

1. **dataフォルダ**
   - SQLiteデータベース（tests.db）
   - データベース関連ファイル（.db-shm、.db-wal）

2. **public/uploadsフォルダ**
   - アップロードされたPDFファイル
   - その他のアップロードファイル

### バックアップの保存

- **保存先**: プロジェクトルートの`backups`フォルダ
- **ファイル形式**: ZIP圧縮ファイル
- **ファイル名**: `backup-YYYY-MM-DDTHH-MM-SS.zip`
- **保存世代数**: 最新7世代
- **古いバックアップ**: 自動的に削除されます

## 技術仕様

### 使用パッケージ

- **node-cron**: スケジューリング機能
- **archiver**: ZIP圧縮機能

### 実装ファイル

1. `lib/backup-scheduler.ts`: バックアップの主要ロジック
2. `lib/scheduler-init.ts`: スケジューラー初期化
3. `instrumentation.ts`: Next.jsサーバー起動時の初期化

### バックアップフロー

1. 毎日19:30にcronジョブが実行
2. `data`フォルダと`public/uploads`フォルダをZIP圧縮
3. `backups`フォルダに保存
4. 8世代以上ある場合、古いバックアップを削除
5. 最新7世代を維持

## 運用上の注意事項

### システム起動時間

- システムが19:30に起動していない場合、その日のバックアップは実行されません
- 継続的にバックアップを取得するには、システムを常時起動させることを推奨します

### ストレージ容量

- バックアップファイルは圧縮されていますが、ディスク容量を消費します
- 7世代分のバックアップが保存されるため、十分なディスク容量を確保してください
- 目安: 1バックアップあたり約1-2MB（データ量により変動）

### バックアップの復元

現在、自動復元機能は実装されていません。バックアップファイルからの復元は手動で行う必要があります。

#### 手動復元手順

1. `backups`フォルダから復元したいZIPファイルを選択
2. ZIPファイルを解凍
3. 解凍された`data`フォルダの内容を、プロジェクトの`data`フォルダに上書きコピー
4. 解凍された`uploads`フォルダの内容を、プロジェクトの`public/uploads`フォルダに上書きコピー
5. システムを再起動

## ログ確認

バックアップの実行状況は、サーバーログで確認できます：

```
自動バックアップスケジューラーが起動しました（毎日19:30に実行）
[2025-11-18T19:30:00.000Z] 自動バックアップを開始します
dataフォルダをバックアップに追加しました
uploadsフォルダをバックアップに追加しました
バックアップ作成完了: backup-2025-11-18T19-30-00.zip (1234567 bytes)
古いバックアップを削除しました: backup-2025-11-11T19-30-00.zip
[2025-11-18T19:30:01.000Z] 自動バックアップが完了しました
```

## トラブルシューティング

### バックアップが作成されない

1. システムが19:30に起動しているか確認
2. `backups`フォルダの書き込み権限を確認
3. サーバーログでエラーメッセージを確認
4. ディスク容量が十分にあるか確認

### バックアップファイルのサイズが異常に大きい

- 不要なファイルが含まれていないか確認
- データベースが肥大化していないか確認

## 今後の改善予定

- [ ] Webインターフェースからのバックアップ実行機能
- [ ] Webインターフェースからの復元機能
- [ ] バックアップの完全性チェック機能
- [ ] 外部ストレージへのバックアップ転送機能
- [ ] バックアップ失敗時のメール通知機能
